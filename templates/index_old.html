<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Health Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .file-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .file-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .file-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
            word-break: break-word;
        }

        .file-meta {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .comment-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .comment-form {
            margin-bottom: 20px;
        }

        .comment-form input,
        .comment-form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-family: inherit;
        }

        .comment-form textarea {
            min-height: 80px;
            resize: vertical;
        }

        .comments-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .comment-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .comment-author {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .comment-text {
            color: #333;
            margin-bottom: 5px;
        }

        .comment-time {
            font-size: 0.8em;
            color: #999;
        }

        .ai-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .ai-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .ai-response {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 4px solid #28a745;
            white-space: pre-wrap;
        }

        .report-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ffc107;
        }

        .report-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin-top: 15px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .budget-section {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #0066cc;
            margin-bottom: 20px;
        }

        .budget-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .budget-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #0066cc;
        }

        .budget-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .budget-card .amount {
            font-size: 2em;
            font-weight: bold;
            color: #0066cc;
        }

        .budget-card .amount.positive {
            color: #28a745;
        }

        .budget-card .amount.negative {
            color: #dc3545;
        }

        .budget-form, .expense-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0066cc;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .expenses-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .expense-info {
            flex: 1;
        }

        .expense-description {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .expense-meta {
            font-size: 0.9em;
            color: #666;
        }

        .expense-amount {
            font-size: 1.2em;
            font-weight: bold;
            color: #dc3545;
            margin-right: 15px;
        }

        .expense-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .badge-capital {
            background: #ffc107;
            color: #000;
        }

        .badge-category {
            background: #667eea;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #ffc107, #ff9800);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #dc3545, #c82333);
        }

        .login-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            margin: 50px auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .login-section h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
        }

        .auth-banner {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            text-align: center;
            display: none;
        }

        .auth-banner.show {
            display: block;
        }

        .auth-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #e7f3ff;
            border-bottom: 2px solid #0066cc;
        }

        .auth-info span {
            font-weight: bold;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="closeLoginModal()">&times;</span>
            <h2>Login Required</h2>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="login-username" placeholder="Enter username" value="admin">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="login-password" placeholder="Enter password" value="admin123">
            </div>
            <button class="btn btn-primary" onclick="login()" style="width: 100%;">Login</button>
            <div id="login-error" style="margin-top: 10px;"></div>
            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 0.9em;">
                <strong>Default Credentials:</strong><br>
                Username: <code>admin</code><br>
                Password: <code>admin123</code>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="auth-banner" class="auth-banner">
            <span id="auth-status"></span>
            <button class="btn btn-secondary" onclick="logout()" style="margin-left: 20px; padding: 5px 15px;">Logout</button>
        </div>
        
        <div class="header">
            <h1>üè• Collaborative Health Tracker</h1>
            <p>Track your health files, add comments, and get AI-powered insights</p>
        </div>

        <div class="content">
            <!-- Files Section -->
            <div class="section">
                <h2 class="section-title">üìÅ Health Files</h2>
                <div id="files-container" class="file-list">
                    <div class="loading">Loading files...</div>
                </div>
            </div>

            <!-- AI Assistant Section -->
            <div class="section">
                <h2 class="section-title">ü§ñ AI Health Assistant</h2>
                <div class="ai-section">
                    <input type="text" id="ai-query" class="ai-input" placeholder="Ask me anything about your health tracking...">
                    <button class="btn btn-primary" onclick="askAI()">Ask AI</button>
                    <div id="ai-response"></div>
                </div>
            </div>

            <!-- Report Generation Section -->
            <div class="section">
                <h2 class="section-title">üìä Generate Health Report</h2>
                <div class="report-section">
                    <button class="btn btn-success" onclick="generateReport()">Generate Comprehensive Report</button>
                    <div id="report-content"></div>
                </div>
            </div>

            <!-- Monthly Budget Section -->
            <div class="section">
                <h2 class="section-title">üí∞ Monthly Budget & Expenses</h2>
                <div class="budget-section">
                    <!-- Budget Summary -->
                    <div id="budget-summary" class="budget-summary">
                        <div class="loading">Loading budget...</div>
                    </div>

                    <!-- Budget Progress Bar -->
                    <div id="budget-progress"></div>

                    <!-- Set Budget Form -->
                    <div class="budget-form">
                        <h3 style="margin-bottom: 15px;">Set Monthly Budget</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Month</label>
                                <input type="month" id="budget-month" value="">
                            </div>
                            <div class="form-group">
                                <label>Total Budget (‚Çπ)</label>
                                <input type="number" id="budget-amount" placeholder="Enter budget amount" step="0.01" min="0">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="setBudget()">Set Budget</button>
                    </div>

                    <!-- Add Expense Form -->
                    <div class="expense-form">
                        <h3 style="margin-bottom: 15px;">Add Expense</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="expense-date" value="">
                            </div>
                            <div class="form-group">
                                <label>Amount (‚Çπ)</label>
                                <input type="number" id="expense-amount" placeholder="Enter amount" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="expense-description" placeholder="What did you spend on?">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Category</label>
                                <select id="expense-category">
                                    <option value="Food & Dining">Food & Dining</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Transportation">Transportation</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Shopping">Shopping</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Education">Education</option>
                                    <option value="Capital Equipment">Capital Equipment</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <div class="checkbox-group" style="margin-top: 10px;">
                                    <input type="checkbox" id="expense-capital">
                                    <label for="expense-capital" style="margin: 0;">Mark as Capital Equipment</label>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addExpense()">Add Expense</button>
                    </div>

                    <!-- Expenses List -->
                    <div class="expenses-list">
                        <h3 style="margin-bottom: 15px;">Recent Expenses</h3>
                        <div id="expenses-list">
                            <div class="loading">Loading expenses...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCommentModal()">&times;</span>
            <h2>Comments for <span id="modal-filename"></span></h2>
            <div class="comment-form">
                <input type="text" id="comment-author" placeholder="Your name (optional)" value="Anonymous">
                <textarea id="comment-text" placeholder="Add your comment..."></textarea>
                <button class="btn btn-primary" onclick="addComment()">Add Comment</button>
            </div>
            <div class="comments-list" id="comments-list"></div>
        </div>
    </div>

    <script>
        let currentFilename = '';
        let sessionId = localStorage.getItem('session_id') || '';
        let isAuthenticated = false;

        // Load files on page load
        window.onload = function() {
            checkAuth();
            loadFiles();
            // Set default month to current month
            const now = new Date();
            const month = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('budget-month').value = month;
            document.getElementById('expense-date').value = now.toISOString().split('T')[0];
            loadBudget();
            loadExpenses();
        };

        // Authentication Functions
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', {
                    headers: {
                        'X-Session-ID': sessionId
                    }
                });
                const data = await response.json();
                
                if (data.success && data.authenticated) {
                    isAuthenticated = true;
                    document.getElementById('auth-banner').classList.add('show');
                    document.getElementById('auth-status').textContent = `Logged in as: ${data.username}`;
                } else {
                    isAuthenticated = false;
                    document.getElementById('auth-banner').classList.remove('show');
                }
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!username || !password) {
                errorDiv.innerHTML = '<div class="error">Please enter username and password</div>';
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    sessionId = data.session_id;
                    localStorage.setItem('session_id', sessionId);
                    isAuthenticated = true;
                    closeLoginModal();
                    checkAuth();
                    errorDiv.innerHTML = '';
                } else {
                    errorDiv.innerHTML = `<div class="error">${data.error}</div>`;
                }
            } catch (error) {
                errorDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'X-Session-ID': sessionId
                    }
                });
                sessionId = '';
                localStorage.removeItem('session_id');
                isAuthenticated = false;
                document.getElementById('auth-banner').classList.remove('show');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function requireAuth(callback) {
            if (!isAuthenticated) {
                showLoginModal();
                return;
            }
            callback();
        }

        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-Session-ID': sessionId
            };
        }

        // Load files from API
        async function loadFiles() {
            try {
                const response = await fetch('/api/files');
                const data = await response.json();
                
                if (data.success) {
                    displayFiles(data.files);
                } else {
                    document.getElementById('files-container').innerHTML = 
                        '<div class="error">Error loading files: ' + data.error + '</div>';
                }
            } catch (error) {
                document.getElementById('files-container').innerHTML = 
                    '<div class="error">Error loading files: ' + error.message + '</div>';
            }
        }

        // Display files
        function displayFiles(files) {
            const container = document.getElementById('files-container');
            
            if (files.length === 0) {
                container.innerHTML = '<div class="error">No files found in Content directory.</div>';
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="file-card">
                    <div class="file-name">${file.name}</div>
                    <div class="file-meta">
                        Size: ${formatFileSize(file.size)}<br>
                        Modified: ${formatDate(file.modified)}
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-primary" onclick="downloadFile('${file.name}')">Download</button>
                        <button class="btn btn-secondary" onclick="viewComments('${file.name}')">Comments</button>
                    </div>
                </div>
            `).join('');
        }

        // Download file
        function downloadFile(filename) {
            window.open(`/api/files/${encodeURIComponent(filename)}`, '_blank');
        }

        // View comments
        async function viewComments(filename) {
            currentFilename = filename;
            document.getElementById('modal-filename').textContent = filename;
            document.getElementById('commentModal').style.display = 'block';
            await loadComments(filename);
        }

        // Close comment modal
        function closeCommentModal() {
            document.getElementById('commentModal').style.display = 'none';
            currentFilename = '';
        }

        // Load comments for a file
        async function loadComments(filename) {
            try {
                const response = await fetch('/api/comments');
                const data = await response.json();
                
                if (data.success) {
                    const comments = data.comments[filename] || [];
                    displayComments(comments);
                }
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        // Display comments
        function displayComments(comments) {
            const container = document.getElementById('comments-list');
            
            if (comments.length === 0) {
                container.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
                return;
            }

            container.innerHTML = comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-author">${comment.author}</div>
                    <div class="comment-text">${comment.comment}</div>
                    <div class="comment-time">${formatDate(comment.timestamp)}</div>
                </div>
            `).join('');
        }

        // Add comment
        async function addComment() {
            requireAuth(async () => {
                const author = document.getElementById('comment-author').value || 'Anonymous';
                const comment = document.getElementById('comment-text').value;
                
                if (!comment.trim()) {
                    alert('Please enter a comment');
                    return;
                }

                try {
                    const response = await fetch('/api/comments', {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            filename: currentFilename,
                            comment: comment,
                            author: author
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        document.getElementById('comment-text').value = '';
                        await loadComments(currentFilename);
                    } else {
                        if (data.auth_required) {
                            showLoginModal();
                        } else {
                            alert('Error adding comment: ' + data.error);
                        }
                    }
                } catch (error) {
                    alert('Error adding comment: ' + error.message);
                }
            });
        }

        // Ask AI
        async function askAI() {
            const query = document.getElementById('ai-query').value;
            
            if (!query.trim()) {
                alert('Please enter a question');
                return;
            }

            const responseDiv = document.getElementById('ai-response');
            responseDiv.innerHTML = '<div class="loading">Thinking...</div>';

            try {
                const response = await fetch('/api/ai/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();
                
                if (data.success) {
                    responseDiv.innerHTML = `<div class="ai-response">${data.response}</div>`;
                } else {
                    responseDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                }
            } catch (error) {
                responseDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Generate report
        async function generateReport() {
            const reportDiv = document.getElementById('report-content');
            reportDiv.innerHTML = '<div class="loading">Generating report...</div>';

            try {
                const response = await fetch('/api/reports/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type: 'comprehensive' })
                });

                const data = await response.json();
                
                if (data.success) {
                    reportDiv.innerHTML = `
                        <div class="success">Report generated successfully!</div>
                        <div class="report-content">
                            <strong>Generated at:</strong> ${formatDate(data.report.generated_at)}<br>
                            <strong>Files tracked:</strong> ${data.report.files_count}<br>
                            <strong>Total comments:</strong> ${data.report.comments_count}<br><br>
                            ${data.report.content}
                        </div>
                    `;
                } else {
                    reportDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                }
            } catch (error) {
                reportDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const commentModal = document.getElementById('commentModal');
            const loginModal = document.getElementById('loginModal');
            if (event.target === commentModal) {
                closeCommentModal();
            }
            if (event.target === loginModal) {
                closeLoginModal();
            }
        }

        // Allow Enter key to submit AI query
        document.getElementById('ai-query').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                askAI();
            }
        });

        // Budget Management Functions
        async function loadBudget() {
            await loadBudgetSummary();
        }

        async function loadBudgetSummary() {
            try {
                const month = document.getElementById('budget-month').value || getCurrentMonth();
                const response = await fetch(`/api/budget/summary?month=${month}`);
                const data = await response.json();
                
                if (data.success) {
                    displayBudgetSummary(data.summary);
                    displayBudgetProgress(data.summary);
                }
            } catch (error) {
                console.error('Error loading budget summary:', error);
            }
        }

        function displayBudgetSummary(data) {
            const summaryDiv = document.getElementById('budget-summary');
            const totalBudget = data.total_budget || 0;
            const totalExpenses = data.total_expenses || 0;
            const remaining = data.remaining || (totalBudget - totalExpenses);
            const capitalExpenses = data.capital_expenses || 0;
            
            summaryDiv.innerHTML = `
                <div class="budget-card">
                    <h3>Total Budget</h3>
                    <div class="amount">‚Çπ${formatCurrency(totalBudget)}</div>
                </div>
                <div class="budget-card">
                    <h3>Total Spent</h3>
                    <div class="amount">‚Çπ${formatCurrency(totalExpenses)}</div>
                </div>
                <div class="budget-card">
                    <h3>Capital Equipment</h3>
                    <div class="amount">‚Çπ${formatCurrency(capitalExpenses)}</div>
                </div>
                <div class="budget-card">
                    <h3>Remaining</h3>
                    <div class="amount ${remaining >= 0 ? 'positive' : 'negative'}">‚Çπ${formatCurrency(remaining)}</div>
                </div>
            `;
        }

        function displayBudgetProgress(data) {
            const progressDiv = document.getElementById('budget-progress');
            const totalBudget = data.total_budget || 0;
            const totalExpenses = data.total_expenses || 0;
            const percentage = totalBudget > 0 ? (totalExpenses / totalBudget * 100) : 0;
            
            let progressClass = 'progress-fill';
            if (percentage >= 100) {
                progressClass += ' danger';
            } else if (percentage >= 80) {
                progressClass += ' warning';
            }
            
            progressDiv.innerHTML = `
                <h3 style="margin-bottom: 10px;">Budget Usage</h3>
                <div class="progress-bar">
                    <div class="${progressClass}" style="width: ${Math.min(percentage, 100)}%">
                        ${percentage.toFixed(1)}%
                    </div>
                </div>
            `;
        }

        async function setBudget() {
            requireAuth(async () => {
                const month = document.getElementById('budget-month').value;
                const amount = parseFloat(document.getElementById('budget-amount').value);
                
                if (!month || !amount || amount <= 0) {
                    alert('Please enter a valid month and budget amount');
                    return;
                }

                try {
                    const response = await fetch('/api/budget', {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            month: month,
                            total_budget: amount
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert('Budget set successfully!');
                        document.getElementById('budget-amount').value = '';
                        await loadBudgetSummary();
                    } else {
                        if (data.auth_required) {
                            showLoginModal();
                        } else {
                            alert('Error setting budget: ' + data.error);
                        }
                    }
                } catch (error) {
                    alert('Error setting budget: ' + error.message);
                }
            });
        }

        async function loadExpenses() {
            try {
                const month = document.getElementById('budget-month').value || getCurrentMonth();
                const response = await fetch(`/api/expenses?month=${month}`);
                const data = await response.json();
                
                if (data.success) {
                    displayExpenses(data.expenses);
                }
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        function displayExpenses(expenses) {
            const container = document.getElementById('expenses-list');
            
            if (expenses.length === 0) {
                container.innerHTML = '<p>No expenses recorded yet.</p>';
                return;
            }

            container.innerHTML = expenses.map(expense => `
                <div class="expense-item">
                    <div class="expense-info">
                        <div class="expense-description">${expense.description}</div>
                        <div class="expense-meta">
                            ${formatDate(expense.date)}
                            <span class="expense-badge badge-category">${expense.category}</span>
                            ${expense.is_capital ? '<span class="expense-badge badge-capital">Capital Equipment</span>' : ''}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="expense-amount">‚Çπ${formatCurrency(expense.amount)}</div>
                        ${isAuthenticated ? `<button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="deleteExpense('${expense.id}')">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function addExpense() {
            requireAuth(async () => {
                const date = document.getElementById('expense-date').value;
                const amount = parseFloat(document.getElementById('expense-amount').value);
                const description = document.getElementById('expense-description').value;
                const category = document.getElementById('expense-category').value;
                const isCapital = document.getElementById('expense-capital').checked;
                const month = date ? date.substring(0, 7) : getCurrentMonth();
                
                if (!date || !amount || amount <= 0 || !description.trim()) {
                    alert('Please fill in all required fields');
                    return;
                }

                try {
                    const response = await fetch('/api/expenses', {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            date: date,
                            amount: amount,
                            description: description,
                            category: category,
                            is_capital: isCapital,
                            month: month
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        // Clear form
                        document.getElementById('expense-amount').value = '';
                        document.getElementById('expense-description').value = '';
                        document.getElementById('expense-capital').checked = false;
                        
                        // Reload expenses and budget
                        await loadExpenses();
                        await loadBudgetSummary();
                    } else {
                        if (data.auth_required) {
                            showLoginModal();
                        } else {
                            alert('Error adding expense: ' + data.error);
                        }
                    }
                } catch (error) {
                    alert('Error adding expense: ' + error.message);
                }
            });
        }

        async function deleteExpense(expenseId) {
            requireAuth(async () => {
                if (!confirm('Are you sure you want to delete this expense?')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/expenses/${expenseId}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        await loadExpenses();
                        await loadBudgetSummary();
                    } else {
                        if (data.auth_required) {
                            showLoginModal();
                        } else {
                            alert('Error deleting expense: ' + data.error);
                        }
                    }
                } catch (error) {
                    alert('Error deleting expense: ' + error.message);
                }
            });
        }

        function getCurrentMonth() {
            const now = new Date();
            return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        }

        function formatCurrency(amount) {
            return parseFloat(amount).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Update budget when month changes
        document.getElementById('budget-month').addEventListener('change', function() {
            loadBudgetSummary();
            loadExpenses();
        });
    </script>
</body>
</html>

